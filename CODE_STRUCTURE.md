# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ ctdaemon - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üìÅ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### `cmd/daemon/main.go` - –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

**–ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫—Ä–∏—Ç–∏—á–µ–Ω)**:
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** - —á–∏—Ç–∞–µ—Ç `conf/config.ini`
2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** - —Å–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–æ–≤ –≤ `./logs`
3. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î** - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ MySQL/PostgreSQL —Å retry logic
4. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Manager** - —Å–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
5. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ã–ª –ª–∏ –¥–µ–º–æ–Ω –∑–∞–ø—É—â–µ–Ω –ø–µ—Ä–µ–¥ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º
6. **–ó–∞–ø—É—Å–∫ REST API —Å–µ—Ä–≤–µ—Ä–∞** - —Å–ª—É—à–∞–µ—Ç HTTP requests –Ω–∞ –ø–æ—Ä—Ç—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
7. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –û–°** - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç SIGINT –∏ SIGTERM –¥–ª—è graceful shutdown

**–ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:
- `Version = "2.0.1"` - —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `configFile` - —Ñ–ª–∞–≥ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –ø—É—Ç–∏ –∫ –∫–æ–Ω—Ñ–∏–≥—É

**Graceful shutdown**:
```
Ctrl+C (SIGINT) –∏–ª–∏ kill -15
  ‚Üì
mgr.Stop() - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  ‚Üì
db.Close() - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ë–î (—á–µ—Ä–µ–∑ defer)
  ‚Üì
logger.Close() - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ª–æ–≥–∏ (—á–µ—Ä–µ–∑ defer)
  ‚Üì
–í—ã—Ö–æ–¥
```

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### `internal/config/config.go` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ INI —Ñ–∞–π–ª–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä—ã**:
```go
Config {
    Database  DatabaseConfig  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î
    Server    ServerConfig    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã API —Å–µ—Ä–≤–µ—Ä–∞
    Log       LogConfig       // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    Trade     TradeConfig     // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—Ä–≥–æ–≤–ª–∏
    OrderBook OrderBookConfig // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–Ω–∏–≥–∏ –æ—Ä–¥–µ—Ä–æ–≤
}
```

**DatabaseConfig - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**:
- `Type` - "mysql" –∏–ª–∏ "postgres"
- `Host`, `Port`, `User`, `Password` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `Name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –ë–î
- `UseTLS` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- `CACert`, `ClientCert`, `ClientKey` - –ø—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –¥–ª—è TLS
- `ConnectTimeoutSec` - —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **`MaxRetries` - –ö–†–ò–¢–ò–ß–ù–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä!** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
  - –ë–µ–∑ –Ω–µ–≥–æ –¥–µ–º–æ–Ω –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∂–µ –æ—à–∏–±–∫–µ –ë–î
  - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚â• 5

**ServerConfig - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã REST API**:
- `Port` - –ø–æ—Ä—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–ª—É—à–∞–µ—Ç API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8080)
- `StateFile` - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

**LogConfig - —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**:
- `Level` - "debug", "info", "warn", "error"
- `Dir` - –ø–∞–ø–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ./logs)
- `MaxFileSizeMB` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π

**–ó–∞–≥—Ä—É–∑–∫–∞**:
```go
cfg, _ := config.Load("conf/config.ini")
// cfg.Database.Host == "mysql-prod.titaev.pro"
// cfg.Log.Level == "info"
```

---

### `internal/logger/logger.go` - –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ä–æ—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Go `slog` (structured logging)
- –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–µ JSON) –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Å timestamp
- –†–∞–∑–Ω—ã–µ –ª–æ–≥–≥–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π (main, trade –∏ —Ç.–¥.)

**–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:
- `Log` - –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫
- `Trade` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- `logFiles` - map –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

**–¢–∏–ø—ã –ª–æ–≥–æ–≤ (–ø–æ —É—Ä–æ–≤–Ω—é –≤–∞–∂–Ω–æ—Å—Ç–∏)**:
```
DEBUG   - –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤ production)
INFO    - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø—É—Å–∫, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ) - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤ production
WARN    - –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –Ω–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, retry)
ERROR   - –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (crash, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
```

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
```go
logger.Init("info", "./logs", 10)  // level, dir, maxFileSizeMB

log := logger.Get("main")
log.Info("Starting", "version", "2.0.1")
log.Error("Connection failed", "error", err)

logger.TradeInfo("Opened position", "pair", "BTC/USDT")
logger.TradeError("Margin low", "level", "critical")
```

**–§–∞–π–ª—ã –ª–æ–≥–æ–≤**:
- `error.log` - –≤—Å–µ –ª–æ–≥–∏ (debug/info/warn/error)
- `trade.log` - —Ç–æ–ª—å–∫–æ —Ç–æ—Ä–≥–æ–≤—ã–µ –ª–æ–≥–∏
- –ü—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏: `error.20231211_150405.log`

**–§—É–Ω–∫—Ü–∏–∏**:
- `Init(level, dir, maxMB)` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `Get(module)` - –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–≥–µ—Ä –¥–ª—è –º–æ–¥—É–ª—è
- `Debug/Info/Warn/Error(msg, args...)` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏
- `TradeInfo/TradeWarn/TradeError()` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏
- `Close()` - –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)

---

### `internal/manager/manager.go` - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª—è–µ—Ç lifecycle –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –∏—Ö —Ä–∞–±–æ—Ç—É.

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å Manager**:
1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** - –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - —á–µ—Ä–µ–∑ context –¥–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –≤—Å–µ–º goroutine –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
3. **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
4. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏** - –∑–Ω–∞–µ—Ç –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –∫–∞–∫ –¥–æ–ª–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```go
Manager {
    cfg            *config.Config    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ctx, cancel    context.Context   // –î–ª—è graceful shutdown
    wg             sync.WaitGroup    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ goroutine
    shutdownOnce   sync.Once         // Guarantee shutdown happens once
    isRunning      bool              // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    startTime      time.Time         // –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    shutdownTime   time.Time         // –ö–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
    shutdownError  error             // –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –±—ã–ª–∞ –ø—Ä–∏ shutdown
}
```

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª**:
```
1. New(cfg) ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä (–µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω)

2. Start() ‚Üí 
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω —É–∂–µ
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç isRunning = true
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç state –Ω–∞ –¥–∏—Å–∫ (–¥–ª—è –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   
3. Stop() ‚Üí 
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∑–∞–ø—É—â–µ–Ω
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç shutdownOnce –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cancel() –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Å–∏–≥–Ω–∞–ª –¥–ª—è –≤—Å–µ—Ö goroutine)
   - –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º (GracefulShutdownTimeout = 30s)
   - –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç –∏—Å—Ç–µ–∫ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ—Ç goroutine
```

**–ú–µ—Ç–æ–¥—ã**:
- `Start()` - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
- `Stop()` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É (graceful)
- `GetStatus()` - –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (running, uptime, start_time –∏ —Ç.–¥.)
- `IsRunning()` - –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- `GetContext()` - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```go
mgr := manager.New(cfg)

// –ó–∞–ø—É—Å–∫
if err := mgr.Start(); err != nil {
    log.Fatal(err)
}

// –ü–æ–∑–∂–µ...
if err := mgr.Stop(); err != nil {
    log.Fatal(err)
}

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
status := mgr.GetStatus()
// status["uptime"] = "2h 30m 45s"
// status["running"] = true
```

---

### `internal/state/state.go` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–µ–º–æ–Ω–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏.

**–ó–∞—á–µ–º –Ω—É–∂–Ω–æ**:
- –ï—Å–ª–∏ –¥–µ–º–æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω –ø–µ—Ä–µ–¥ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- –ï—Å–ª–∏ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Üí –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞/—Ç–æ—Ä–≥–æ–≤–ª–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```go
State {
    IsRunning bool  // –ë—ã–ª –ª–∏ –∑–∞–ø—É—â–µ–Ω –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
}

Manager {
    filePath string      // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (state/daemon.state)
    state    *State      // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
    mu       sync.RWMutex // –î–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
}
```

**Singleton –ø–∞—Ç—Ç–µ—Ä–Ω**:
```go
// –ü–æ–ª—É—á–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
mgr := state.GetInstance()
```

**–§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è** - `state/daemon.state`:
```json
{
  "is_running": true
}
```

**–ú–µ—Ç–æ–¥—ã**:
- `GetInstance()` - –ø–æ–ª—É—á–∏—Ç—å singleton Manager
- `Load()` - –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –¥–∏—Å–∫–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ init)
- `Save()` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –¥–∏—Å–∫
- `SetRunning(bool)` - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
- `IsRunning()` - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–ª–∞–≥

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```go
// –í main.go –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
if state.GetInstance().IsRunning() {
    mgr.Start() // –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç
}

// –í manager.Start():
state.GetInstance().SetRunning(true)

// –í manager.Stop():
state.GetInstance().SetRunning(false)
```

---

## üìä –ú–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏

**–í—Å–µ timestamp –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ú–ò–ö–†–û–°–ï–ö–£–ù–î–´ (microseconds)**:

```
–ü—Ä–∏–º–µ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π:
- 1702274400000000 = 2023-12-11 12:00:00 UTC (–≤ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–∞—Ö)
- 1702274400000 = 2023-12-11 12:00:00 UTC (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)

–ö–æ–Ω–≤–µ—Ä—Å–∏—è:
- –ò–∑ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥: ms √ó 1000 = Œºs
- –ò–∑ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥: ns √∑ 1000 = Œºs
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**:
- `exchange.OrderBook.Timestamp` - –∫–æ–≥–¥–∞ –±–∏—Ä–∂–∞ –≤—ã—Å–ª–∞–ª–∞ update
- `messaging.Message.Timestamp` - –∫–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ë–î

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥**:
- ‚úì –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö –±–∏—Ä–∂
- ‚úì –õ–µ–≥–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- ‚úì –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è HFT —Å–∏—Å—Ç–µ–º
- ‚úì –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Go: `time.UnixMicro()`

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
OS Signal (SIGINT/SIGTERM)
  ‚Üì
main() –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç mgr.Stop()
  ‚Üì
Manager.Stop()
  ‚Üì
Manager.doStop() - graceful shutdown
  ‚îú‚îÄ cancel() - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
  ‚îú‚îÄ –í—Å–µ goroutine –≤–∏–¥—è—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–º–µ–Ω–µ–Ω
  ‚îú‚îÄ –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30s
  ‚îî‚îÄ –ï—Å–ª–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å - force cancel
  ‚Üì
state.SetRunning(false) - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  ‚Üì
db.Close() - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ë–î
  ‚Üì
logger.Close() - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ª–æ–≥–∏
  ‚Üì
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
```

---

## üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ |
|------|-----------|--------------|-----------|
| main.go | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ | –ü–æ—Ä—è–¥–æ–∫ –∫—Ä–∏—Ç–∏—á–µ–Ω | graceful shutdown |
| config.go | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | –ü–µ—Ä–≤—ã–º (–Ω—É–∂–Ω–∞ –¥–ª—è –≤—Å–µ—Ö) | –ù/–ê |
| logger.go | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | –í—Ç–æ—Ä—ã–º (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) | Close() –≤ defer |
| manager.go | –ú–µ–Ω–µ–¥–∂–µ—Ä | –ß–µ—Ç–≤–µ—Ä—Ç—ã–º | Stop() ‚Üí graceful |
| state.go | –°–æ—Å—Ç–æ—è–Ω–∏–µ | –ü—Ä–∏ init Manager | SetRunning(false) |

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
# –ü–æ–º–æ—â—å
./ctdaemon -h

# –° –∫–æ–Ω—Ñ–∏–≥–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
./ctdaemon

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º
./ctdaemon -c /path/to/config.ini
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ª–æ–≥–æ–≤
tail -f logs/error.log

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ—Ä–≥–æ–≤—ã—Ö –ª–æ–≥–æ–≤
tail -f logs/trade.log

# –ü–æ—Å–ª–µ–¥–Ω–∏—Ö 100 —Å—Ç—Ä–æ–∫
tail -100 logs/error.log

# –° —Ñ–∏–ª—å—Ç—Ä–æ–º
grep "ERROR" logs/error.log
grep "Connection" logs/error.log
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**TLS/SSL –ø–æ–¥–¥–µ—Ä–∂–∫–∞**:
```ini
[database]
use_tls = true
ca_cert = /path/to/ca.pem
client_cert = /path/to/client.pem
client_key = /path/to/client.key
```

**–¢–∞–π–º–∞—É—Ç—ã**:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ë–î: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10s)
- Graceful shutdown: 30 —Å–µ–∫—É–Ω–¥ (GracefulShutdownTimeout)
- Retry logic: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ = MaxRetries –≤ –∫–æ–Ω—Ñ–∏–≥–µ

